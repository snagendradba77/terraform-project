name: Deploy SQL Server Docker

on:
  push:
    branches:
      - main
    paths:
      - "env/dev/**"
      - "env/test/**"
      - "env/prod/**"

jobs:

  detect-changes:
    runs-on: self-hosted
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Detect modified folders
        id: detect
        run: |
          git fetch origin main
          CHANGED=$(git diff --name-only HEAD~1 HEAD || true)
          echo "Changed files: $CHANGED"

          MATRIX="{\"include\":["
          FIRST=true

          if echo "$CHANGED" | grep -q "^env/dev/"; then
            MATRIX="$MATRIX{\"environment\":\"dev\"}"
            FIRST=false
          fi
          if echo "$CHANGED" | grep -q "^env/test/"; then
            [ "$FIRST" = false ] && MATRIX="$MATRIX,"
            MATRIX="$MATRIX{\"environment\":\"test\"}"
            FIRST=false
          fi
          if echo "$CHANGED" | grep -q "^env/prod/"; then
            [ "$FIRST" = false ] && MATRIX="$MATRIX,"
            MATRIX="$MATRIX{\"environment\":\"prod\"}"
          fi

          MATRIX="$MATRIX]}"
          echo "Matrix JSON: $MATRIX"

          # Store matrix into a temp file to pass to next step
          echo "$MATRIX" > matrix.json

      - name: Set matrix output
        id: set-matrix
        run: echo "matrix=$(cat matrix.json)" >> $GITHUB_OUTPUT

      - name: Debug matrix
        env:
          MATRIX: ${{ steps.set-matrix.outputs.matrix }}
        run: |
          echo "Final Matrix Output: $MATRIX"


  terraform:
    needs: detect-changes
    runs-on: self-hosted

    if: ${{ needs.detect-changes.outputs.matrix != '{"include":[]}' }}

    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}

    environment: ${{ matrix.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Terraform Init & Apply
        working-directory: env/${{ matrix.environment }}
        run: |
          terraform init
          terraform apply -auto-approve

