name: Deploy SQL Server Docker

on:
  push:
    branches:
      - main
    paths:
      - "env/dev/**"
      - "env/test/**"
      - "env/prod/**"

jobs:
  detect-changes:
    runs-on: self-hosted
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch full history for git diff

      - name: Detect modified folders
        id: detect
        run: |
          # Ensure we have the latest main branch
          git fetch origin main
          CHANGED=$(git diff --name-only origin/main...HEAD || true)
          echo "Changed files: $CHANGED"

          MATRIX="{\"include\":["
          FIRST=true

          if echo "$CHANGED" | grep -q "^env/dev/"; then
            MATRIX="$MATRIX{\"environment\":\"dev\"}"
            FIRST=false
          fi
          if echo "$CHANGED" | grep -q "^env/test/"; then
            [ "$FIRST" = false ] && MATRIX="$MATRIX,"
            MATRIX="$MATRIX{\"environment\":\"test\"}"
            FIRST=false
          fi
          if echo "$CHANGED" | grep -q "^env/prod/"; then
            [ "$FIRST" = false ] && MATRIX="$MATRIX,"
            MATRIX="$MATRIX{\"environment\":\"prod\"}"
          fi

          MATRIX="$MATRIX]}"
          echo "Detected matrix: $MATRIX"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

      - name: Set matrix output
        id: set-matrix
        run: echo "::set-output name=matrix::${{ steps.detect.outputs.matrix }}"

      - name: Debug matrix
        run: echo "Matrix output: ${{

