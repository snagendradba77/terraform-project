name: Deploy SQL Server Docker

on:
  push:
    branches:
      - main
    paths:
      - "env/dev/**"
      - "env/test/**"
      - "env/prod/**"
  pull_request:
    branches:
      - main
    paths:
      - "env/dev/**"
      - "env/test/**"
      - "env/prod/**"

jobs:
  detect-changes:
    runs-on: self-hosted
    outputs:
      matrix: ${{ steps.detect.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Detect modified folders
        id: detect
        run: |
          git fetch origin main || true
          CHANGED=$(git diff --name-only origin/main...HEAD || true)
          echo "Changed files: $CHANGED"

          MATRIX="{\"include\":["
          FIRST=true

          if echo "$CHANGED" | grep -q "^env/dev/"; then
            MATRIX="$MATRIX{\"environment\":\"dev\"}"
            FIRST=false
          fi
          if echo "$CHANGED" | grep -q "^env/test/"; then
            [ "$FIRST" = false ] && MATRIX="$MATRIX,"
            MATRIX="$MATRIX{\"environment\":\"test\"}"
            FIRST=false
          fi
          if echo "$CHANGED" | grep -q "^env/prod/"; then
            [ "$FIRST" = false ] && MATRIX="$MATRIX,"
            MATRIX="$MATRIX{\"environment\":\"prod\"}"
          fi

          MATRIX="$MATRIX]}"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

      - name: Debug matrix
        run: echo "Matrix output: ${{ steps.detect.outputs.matrix }}"

  terraform:
    needs: detect-changes
    runs-on: self-hosted
    strategy:
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        working-directory: env/${{ matrix.environment }}
        run: terraform init -input=false

      - name: Terraform Plan
        working-directory: env/${{ matrix.environment }}
        run: terraform plan -input=false -out=tfplan

      - name: Terraform Apply (non-prod)
        if: matrix.environment != 'prod' && github.event_name == 'push'
        working-directory: env/${{ matrix.environment }}
        run: terraform apply -input=false -auto-approve tfplan

  prod-apply:
    needs: terraform
    runs-on: self-hosted
    if: contains(needs.detect-changes.outputs.matrix, '"environment":"prod"')
    environment: prod   # ðŸ‘ˆ approval handled in GitHub GUI
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init (prod)
        working-directory: env/prod
        run: terraform init -input=false

      - name: Terraform Plan (prod)
        working-directory: env/prod
        run: terraform plan -input=false -out=tfplan

      - name: Terraform Apply (prod, after approval)
        working-directory: env/prod
        run: terraform apply -input=false -auto-approve tfplan

